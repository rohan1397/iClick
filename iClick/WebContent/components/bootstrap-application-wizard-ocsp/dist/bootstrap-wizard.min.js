!function(t){t.fn.wizard=function(t){return new Wizard(this,t)},t.fn.wizard.logging=!1;var i=function(t,i,s,e,n){this.wizard=t,this.index=s,this.prev=e,this.next=n,this.el=i,this.title=i.find("h3").first().text(),this.name=i.data("cardname")||this.title,this.nav=this._createNavElement(this.title,s),this._disabled=!1,this._loaded=!1,this._events={}};i.prototype={select:function(){this.log("selecting"),this.isSelected()||(this.nav.addClass("active"),this.el.show(),this._loaded||(this.trigger("loaded"),this.reload()),this.trigger("selected"));var t=this.wizard;return t.backButton.toggleClass("disabled",0==this.index),this.index>=t._cards.length-1?(this.log("on last card, changing next button to submit"),t.changeNextButton(t.args.buttons.submitText,"btn-success"),t._readyToSubmit=!0,t.trigger("readySubmit")):(t._readyToSubmit=!1,t.changeNextButton(t.args.buttons.nextText,"btn-primary")),this},_createNavElement:function(i,s){var e=t('<li class="wizard-nav-item"></li>'),n=t('<a class="wizard-nav-link"></a>');return n.data("navindex",s),e.append(n),n.append('<span class="glyphicon glyphicon-chevron-right"></span> '),n.append(i),e},markVisited:function(){return this.log("marking as visited"),this.nav.addClass("already-visited"),this.trigger("markVisited"),this},unmarkVisited:function(){return this.log("unmarking as visited"),this.nav.removeClass("already-visited"),this.trigger("unmarkVisited"),this},deselect:function(){return this.nav.removeClass("active"),this.el.hide(),this.trigger("deselect"),this},enable:function(){return this.log("enabling"),this.nav.addClass("active"),this._disabled=!1,this.trigger("enabled"),this},disable:function(t){return this.log("disabling"),this._disabled=!0,this.nav.removeClass("active already-visited"),t&&this.el.hide(),this.trigger("disabled"),this},isDisabled:function(){return this._disabled},alreadyVisited:function(){return this.nav.hasClass("already-visited")},isSelected:function(){return this.nav.hasClass("active")},reload:function(){return this._loaded=!0,this.trigger("reload"),this},on:function(){return this.wizard.on.apply(this,arguments)},trigger:function(){return this.callListener("on"+arguments[0]),this.wizard.trigger.apply(this,arguments)},toggleAlert:function(i,s){this.log("toggling alert to: "+s),s="undefined"==typeof s||s,s?this.trigger("showAlert"):this.trigger("hideAlert");var e,n=this.el.children("h3").first().next("div.alert");if(0==n.length){if(!s)return this;this.log("couldn't find existing alert div, creating one"),e=t("<div />"),e.addClass("alert"),e.addClass("hide"),e.insertAfter(this.el.find("h3").first())}else this.log("found existing alert div"),e=n.first();return s?(null!=i&&(this.log("setting alert msg to",i),e.html(i)),e.show()):e.hide(),this},callListener:function(t){t=t.toLowerCase(),this.log("looking for listener "+t);var i=window[this.el.data(t)];if(i){this.log("calling listener "+t);this.wizard;try{i(this)}catch(i){this.log("exception calling listener "+t+": ",i)}}else this.log("didn't find listener "+t)},problem:function(t){this.nav.find("a").toggleClass("wizard-step-error",t)},validate:function(){var i=!1,s=this;this.el.find("[data-validate]").each(function(e,n){s.log("validating individiual inputs"),n=t(n);var r=n.data("validate");if(r){var a={status:!0,title:"Error",msg:""},o=window[r](n);if(t.extend(a,o),1===t("#btn-"+n.attr("id")).length&&(n=t("#btn-"+n.attr("id"))),a.status){n.parents("div.form-group").toggleClass("has-error",!1),1===t("#btn-"+n.attr("id")).length&&(n=t("#btn-"+n.attr("id")));try{n.popover("destroy")}catch(t){n.popover("hide")}}else i=!0,n.parents("div.form-group").toggleClass("has-error",!0),1===t("#btn-"+n.attr("id")).length&&(n=t("#btn-"+n.attr("id"))),s.wizard.errorPopover(n,a.msg)}}),this.log("after validating inputs, failures is",i);var e=window[this.el.data("validate")];if(e){this.log("running html-embedded card validator");var n=e(this);"undefined"!=typeof n&&null!=n||(n=!0),n||(i=!0),this.log("after running html-embedded card validator, failures is",i)}this.log("running listener validator");var r=this.trigger("validate");"undefined"!=typeof r&&null!=r||(r=!0),r||(i=!0),this.log("after running listener validator, failures is",i);var a=!i;return a?(this.log("validated, calling listeners"),this.trigger("validated")):(this.log("invalid"),this.trigger("invalid")),a},log:function(){if(window.console&&t.fn.wizard.logging){var i="card '"+this.name+"': ",s=[i];s.push.apply(s,arguments),console.log.apply(console,s)}},isActive:function(){return this.nav.hasClass("active")}},Wizard=function(i,s){this.wizard_template=['<div  class="modal fade wizard">','<div class="modal-dialog wizard-dialog">','<div class="modal-content wizard-content">','<div class="modal-header wizard-header">','<button type="button" class="close wizard-close" aria-hidden="true">&times;</button>','<h3 class="modal-title wizard-title"></h3>','<span class="wizard-subtitle"></span>',"</div>",'<div class="modal-body wizard-body">','<div class="pull-left wizard-steps">','<div class="wizard-nav-container">','<ul class="nav wizard-nav-list">',"</ul>","</div>",'<div class="wizard-progress-container">','<div class="progress progress-striped">','<div class="progress-bar" style="width: 0%;"></div>',"</div>","</div>","</div>","<form>",'<div class="wizard-cards">','<div class="wizard-card-container">',"</div>",'<div class="wizard-footer">','<div class="wizard-buttons-container">','<button class="btn wizard-cancel wizard-close" type="button">Cancel</button>','<div class="btn-group-single pull-right">','<button class="btn wizard-back" type="button">Back</button>','<button class="btn btn-primary wizard-next" type="button">Next</button>',"</div>","</div>","</div>","</div>","</form>","</div>","</div>","</div>","</div>"],this.args={keyboard:!0,backdrop:!0,show:!1,submitUrl:"",showCancel:!1,showClose:!0,progressBarCurrent:!1,increaseHeight:0,contentHeight:300,contentWidth:580,buttons:{cancelText:"Cancel",nextText:"Next",backText:"Back",submitText:"Submit",submittingText:"Submitting..."},formClass:"form-horizontal"},t.extend(this.args,s||{}),this._create(i)},Wizard.prototype={log:function(){if(window.console&&t.fn.wizard.logging){var i="wizard "+this.el.id+": ",s=[i];s.push.apply(s,arguments),console.log.apply(console,s)}},_create:function(i){this.markup=t(i),this.title=this.markup.data("title"),this.submitCards=this.markup.find(".wizard-error,.wizard-failure,.wizard-success,.wizard-loading"),this.el=t(this.wizard_template.join("\n")),t("body").append(this.el),this.modal=this.el.modal({keyboard:this.args.keyboard,show:this.args.show,backdrop:this.args.backdrop}),this.dimensions={contentHeight:this.args.contentHeight,contentWidth:this.args.contentWidth},this.dialog=this.modal.find(".wizard-dialog"),this.content=this.modal.find(".wizard-content"),this.header=this.modal.find(".wizard-header"),this.body=this.modal.find(".wizard-body"),this.wizardSteps=this.modal.find(".wizard-steps"),this.wizardCards=this.modal.find(".wizard-cards"),this.wizardCardContainer=this.modal.find(".wizard-card-container"),this.wizardCardContainer.append(this.markup.find(".wizard-card")).append(this.submitCards),this.navContainer=this.modal.find(".wizard-nav-container"),this.navList=this.modal.find(".wizard-nav-list"),this.progressContainer=this.modal.find(".wizard-progress-container"),this.progress=this.progressContainer.find(".progress-bar"),this.closeButton=this.modal.find("button.wizard-close.close"),this.cardsContainer=this.modal.find("wizard-cards-container"),this.form=this.modal.find("form"),this.footer=this.modal.find(".wizard-footer"),this.cancelButton=this.footer.find(".wizard-cancel"),this.backButton=this.footer.find(".wizard-back"),this.nextButton=this.footer.find(".wizard-next"),this._cards=[],this.cards={},this._readyToSubmit=!1,this.percentComplete=0,this._submitting=!1,this._events={},this._firstShow=!0,this._createCards(),this.nextButton.click(this,this._handleNextClick),this.backButton.click(this,this._handleBackClick),this.cancelButton.text(this.args.buttons.cancelText),this.backButton.text(this.args.buttons.backText),this.nextButton.text(this.args.buttons.nextText),this.form.addClass(this.args.formClass),this.popovers=[];var s=this,e=function(){s.reset(),s.close(),s.trigger("closed")};this.closeButton.click(e),this.cancelButton.click(e),this.wizardSteps.on("click","li.already-visited a.wizard-nav-link",this,function(i){var s=parseInt(t(i.target).data("navindex"));i.data.setCard(s)}),0!=this.title.length&&this.setTitle(this.title),this.on("submit",this._defaultSubmit),this.autoDimensions()},autoDimensions:function(){this.modal.css("display","block"),this.dimensions.header=this.header.outerHeight(!0),this.dimensions.navigation=this.wizardSteps.outerHeight(!0),this.dimensions.navigation<this.dimensions.contentHeight&&(this.dimensions.navigation=this.dimensions.contentHeight,this.navContainer.height(this.dimensions.contentHeight-30-this.progressContainer.outerHeight(!0))),this.dimensions.body=this.dimensions.navigation,this.wizardSteps.height(this.dimensions.body),this.dimensions.modal=this.dimensions.header+this.dimensions.navigation,this.content.height(this.dimensions.modal+"px"),this.dialog.width(this.dimensions.contentWidth),this.body.height(this.dimensions.body+"px"),this.wizardCards.height(this.dimensions.body+"px"),this.dimensions.footer=this.footer.outerHeight(!0),this.dimensions.cardContainer=this.dimensions.body-this.dimensions.footer,this.wizardCardContainer.height(this.dimensions.cardContainer),this.dimensions.offset=(t(window).height()-this.dialog.height())/2,this.dialog.css({"margin-top":this.dimensions.offset+"px","padding-top":0}),this.modal.css("display","")},setTitle:function(t){return this.log("setting title to",t),this.modal.find(".wizard-title").first().text(t),this},setSubtitle:function(t){return this.log("setting subtitle to",t),this.modal.find(".wizard-subtitle").first().text(t),this},errorPopover:function(t,i,s){this.log("launching popover on",t),s="undefined"!=typeof s&&s;var e=t.popover({content:i,trigger:"manual",html:s,container:t.parents(".form-group")}).addClass("error-popover").popover("show").next(".popover");return t.parents(".form-group").find(".popover").addClass("error-popover"),this.popovers.push(t),e},destroyPopover:function(i){i=t(i);try{i.popover("destroy")}catch(t){i.popover("hide")}},hidePopovers:function(i){this.log("hiding all popovers");var s=this;t.each(this.popovers,function(t,i){s.destroyPopover(i)}),this.modal.find(".has-error").removeClass("has-error"),this.popovers=[]},eachCard:function(i){return t.each(this._cards,i),this},getActiveCard:function(){this.log("getting active card");var i=null;return t.each(this._cards,function(t,s){if(s.isActive())return i=s,!1}),i?this.log("found active card",i):this.log("couldn't find an active card"),i},changeNextButton:function(t,i){return this.log("changing next button, text: "+t,"class: "+i),"undefined"!=typeof i&&this.nextButton.removeClass("btn-success btn-primary"),i&&this.nextButton.addClass(i),this.nextButton.text(t),this},hide:function(){return this.log("hiding"),this.modal.modal("hide"),this},close:function(){return this.log("closing"),this.modal.modal("hide"),this},show:function(t){return this.log("showing"),this._firstShow&&(this.setCard(0),this._firstShow=!1),this.args.showCancel?this.cancelButton.show():this.cancelButton.hide(),this.args.showClose&&this.closeButton.show(),this.modal.modal("show"),this},on:function(t,i){return this.log("adding listener to event "+t),this._events[t]=i,this},trigger:function(){var t=arguments[0],i=Array.prototype.slice.call(arguments);i.shift(),i.unshift(this),this.log("firing event "+t);var s=this._events[t];void 0===s&&void 0!==this.wizard&&(s=this.wizard._events[t]);var e=null;if("function"==typeof s){this.log("found event handler, calling "+t);try{e=s.apply(this,i)}catch(i){this.log("event handler "+t+" had an exception")}}else this.log("couldn't find an event handler for "+t);return e},reset:function(){return this.log("resetting"),this.updateProgressBar(0),this.hideSubmitCards(),this.setCard(0),this.lockCards(),this.enableNextButton(),this.showButtons(),this.hidePopovers(),this.trigger("reset"),this},_abstractIncrementStep:function(t,i){var s,e=this.getActiveCard();if(e)for(this.log("searching for valid next card");;){if(s=i(e)){if(this.log("looking at card",s.index),s.isDisabled()){this.log("card "+s.index+" is disabled/locked, continuing"),e=s;continue}return this.setCard(e.index+t)}this.log("next card is not defined, breaking");break}else this.log("current card is undefined")},incrementCard:function(){this.log("incrementing card");var t=this._abstractIncrementStep(1,function(t){return t.next});return this.trigger("incrementCard"),t},decrementCard:function(){this.log("decrementing card");var t=this._abstractIncrementStep(-1,function(t){return t.prev});return this.trigger("decrementCard"),t},setCard:function(t){this.log("setting card to "+t),this.hideSubmitCards();var i=this.getActiveCard();if(this._submitting)return this.log("we're submitting the wizard already, can't change cards"),i;var s=this._cards[t];if(s){if(s.isDisabled())return this.log("new card is currently disabled, returning"),i;if(i){if(t>i.index){for(var e=i,n=!1;e.index!=s.index;){if(e.index!=i.index&&(e.prev.deselect(),e.prev.markVisited(),e.select()),n=e.validate(),!n)return e;e=e.next}e.prev.deselect(),e.prev.markVisited()}i.deselect(),i.markVisited()}if(s.select(),this.args.progressBarCurrent)this.percentComplete=100*t/this._cards.length,this.updateProgressBar(this.percentComplete);else{var r=this.percentComplete;this.percentComplete=100*t/this._cards.length,this.percentComplete=Math.max(r,this.percentComplete),this.updateProgressBar(this.percentComplete)}return s}this.log("couldn't find card "+t)},updateProgressBar:function(t){this.log("updating progress to "+t+"%"),this.progress.css({width:t+"%"}),this.percentComplete=t,this.trigger("progressBar",t),100==t?(this.log("progress is 100, animating progress bar"),this.progressContainer.find(".progress").addClass("active")):0==t&&(this.log("progress is 0, disabling animation"),this.progressContainer.find(".progress").removeClass("active"))},getNextCard:function(){var t=this.getActiveCard();if(t)return t.next},lockCards:function(){return this.log("locking nav cards"),this.eachCard(function(t,i){i.unmarkVisited()}),this},disableCards:function(){return this.log("disabling all nav cards"),this.eachCard(function(t,i){i.disable()}),this},enableCards:function(){return this.log("enabling all nav cards"),this.eachCard(function(t,i){i.enable()}),this},hideCards:function(){return this.log("hiding cards"),this.eachCard(function(t,i){i.deselect()}),this.hideSubmitCards(),this},hideButtons:function(){return this.log("hiding buttons"),this.cancelButton.hide(),this.closeButton.hide(),this.nextButton.hide(),this.backButton.hide(),this},showButtons:function(){return this.log("showing buttons"),this.args.showCancel?this.cancelButton.show():this.cancelButton.hide(),this.args.showClose&&this.closeButton.show(),this.nextButton.show(),this.backButton.show(),this},getCard:function(i){var s=t(i).parents(".wizard-card").first()[0];if(s){var e=null;return this.eachCard(function(t,i){return s!=i.el[0]||(e=i,!1)}),e}return null},_createCards:function(){var s=null,e=null,n=null,r=this,a=this;a.log("Creating Cards");var o=this.modal.find(".wizard-cards .wizard-card");t.each(o,function(o,d){d=t(d),s=n,n=new i(r,d,o,s,e),a._cards.push(n),n.name&&(a.cards[n.name]=n),s&&(s.next=n),a.modal.find(".wizard-steps .wizard-nav-list").append(n.nav)})},showSubmitCard:function(t){this.log("showing "+t+" submit card");var i=this.el.find(".wizard-"+t);i.length?(this.hideCards(),this.el.find(".wizard-"+t).show()):this.log("couldn't find submit card "+t)},hideSubmitCard:function(t){this.log("hiding "+t+" submit card"),this.el.find(".wizard-"+t).hide()},hideSubmitCards:function(){var i=this;t.each(["success","error","failure","loading"],function(t,s){i.hideSubmitCard(s)})},enableNextButton:function(){return this.log("enabling next button"),this.nextButton.removeAttr("disabled"),this},disableNextButton:function(){return this.log("disabling next button"),this.nextButton.attr("disabled","disabled"),this},serializeArray:function(){var i=this.form.serializeArray();return this.form.find('input[disabled][data-serialize="1"]').each(function(){formObj={name:t(this).attr("name"),value:t(this).val()},i.push(formObj)}),i},serialize:function(){var i=this.form.serialize();return this.form.find('input[disabled][data-serialize="1"]').each(function(){i=i+"&"+t(this).attr("name")+"="+t(this).val()}),i},find:function(t){return this.modal.find(t)},submitSuccess:function(){this.log("submit success"),this._submitting=!1,this.showSubmitCard("success"),this.trigger("submitSuccess")},submitFailure:function(){this.log("submit failure"),this._submitting=!1,this.showSubmitCard("failure"),this.trigger("submitFailure")},submitError:function(){this.log("submit error"),this._submitting=!1,this.showSubmitCard("error"),this.trigger("submitError")},_submit:function(){this.log("submitting wizard"),this._submitting=!0,this.lockCards(),this.cancelButton.hide(),this.closeButton.hide(),this.backButton.hide(),this.showSubmitCard("loading"),this.updateProgressBar(100),this.changeNextButton(this.args.buttons.submittingText,!1),this.disableNextButton();this.trigger("submit");this.trigger("loading")},_onNextClick:function(){this.log("handling 'next' button click");var t=this.getActiveCard();this._readyToSubmit&&t.validate()?this._submit():t=this.incrementCard()},_onBackClick:function(){this.log("handling 'back' button click");this.decrementCard()},_handleNextClick:function(t){var i=t.data;i._onNextClick.call(i)},_handleBackClick:function(t){var i=t.data;i._onBackClick.call(i)},_defaultSubmit:function(i){t.ajax({type:"POST",url:i.args.submitUrl,data:i.serialize(),dataType:"json"}).done(function(t){i.submitSuccess(),i.hideButtons(),i.updateProgressBar(0)}).fail(function(){i.submitFailure(),i.hideButtons()})}}}(window.jQuery);